include(faust)

add_library(ceammc_static STATIC ceammc.c ceammc.cpp)
set_target_properties(ceammc_static PROPERTIES
    COMPILE_FLAGS ${PD_EXTERNAL_CFLAGS})

add_custom_target(ceammc_generate_math
    COMMAND ${CMAKE_SOURCE_DIR}/ceammc/py/generate_math.py
    WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR})
    
macro(ceammc_extension module name ext)
    pd_add_extension(NAME "${module}.${name}" 
        FILES "${module}_${name}.${ext}"
        INTERNAL True
        LIBRARY ceammc
        LINK ceammc_static)
endmacro()    
    
macro(ceammc_c_extension module name)
    ceammc_extension(${module} ${name} c)
endmacro()

macro(ceammc_cxx_extension module name)
    ceammc_extension(${module} ${name} cpp)
endmacro()

macro(ceammc_extension_ module name ext)
    pd_add_extension(NAME "${module}_${name}"
        FILES "${module}_${name}.${ext}"
        INTERNAL True
        LIBRARY ceammc
        LINK ceammc_static)
endmacro()

macro(ceammc_c_extension_ module name)
    ceammc_extension_(${module} ${name} c)
endmacro()

macro(ceammc_cxx_extension_ module name)
    ceammc_extension_(${module} ${name} cpp)
endmacro()

macro(ceammc_apple_link_fix module name)
    add_custom_command(TARGET "${module}.${name}" POST_BUILD
        COMMAND bash ${CMAKE_CURRENT_SOURCE_DIR}/apple_poco_path_fix.sh
                $<TARGET_FILE:${module}.${name}>
                ${CMAKE_CURRENT_BINARY_DIR})
endmacro()

macro(ceammc_glib_extension module name)
    pd_add_extension(NAME "${module}.${name}"
        FILES "${module}_${name}.cpp" INTERNAL True
        LINK ${GLIB_LIBRARIES})

    if(APPLE)
        ceammc_apple_link_fix(${module} ${name})
    endif()
endmacro()

macro(ceammc_glib_extension_ module name)
    pd_add_extension(NAME "${module}_${name}"
        FILES "${module}_${name}.cpp" INTERNAL True
        LINK ${GLIB_LIBRARIES})

    if(APPLE)
        ceammc_apple_link_fix(${module} ${name})
    endif()
endmacro()

macro(ceammc_faust_extension module name ext)
    add_custom_target("faust_${module}_${name}"
        COMMAND ${FAUST_BIN} -vec -vs 64 -i
            -a ${CMAKE_SOURCE_DIR}/ceammc/faust/${ext}.cpp
            -cn ${name}
            "${CMAKE_SOURCE_DIR}/ceammc/faust/${module}_${name}.dsp"
            -o ${CMAKE_CURRENT_SOURCE_DIR}/${module}_${name}.h)

    pd_add_extension(NAME "${module}.${name}~"
        FILES "${module}_${name}.cpp" INTERNAL TRUE)
endmacro()


###############################
# MATH
###############################
# begin autogenerated
ceammc_c_extension(math abs)
ceammc_c_extension(math acos)
ceammc_c_extension(math acosh)
ceammc_c_extension(math asin)
ceammc_c_extension(math asinh)
ceammc_c_extension(math atan)
ceammc_c_extension(math atanh)
ceammc_c_extension(math cbrt)
ceammc_c_extension(math ceil)
ceammc_c_extension(math cos)
ceammc_c_extension(math cosh)
ceammc_c_extension(math exp)
ceammc_c_extension(math exp2)
ceammc_c_extension(math floor)
ceammc_c_extension(math log)
ceammc_c_extension(math log10)
ceammc_c_extension(math log2)
ceammc_c_extension(math round)
ceammc_c_extension(math sin)
ceammc_c_extension(math sinh)
ceammc_c_extension(math sqrt)
ceammc_c_extension(math tan)
ceammc_c_extension(math tanh)
# end autogenerated
ceammc_c_extension(math pi)
ceammc_c_extension(math e)
ceammc_c_extension(math nan)
ceammc_c_extension(math inf)
ceammc_c_extension(math reciprocal)
ceammc_c_extension(math sign)
ceammc_c_extension(math neg)
ceammc_c_extension(math squared)

###############################
# DATA
###############################
ceammc_cxx_extension(data fifo)

###############################
# LIST
###############################
ceammc_cxx_extension(list at)
ceammc_cxx_extension(list count)
ceammc_c_extension(list length)
ceammc_cxx_extension(list each)
ceammc_cxx_extension(list equal)
ceammc_cxx_extension(list last)
ceammc_cxx_extension(list max)
ceammc_cxx_extension(list mean)
ceammc_cxx_extension(list min)
ceammc_cxx_extension(list minmax)
ceammc_cxx_extension(list normalize)
ceammc_c_extension(list product)
ceammc_cxx_extension(list repeat)
ceammc_cxx_extension(list reverse)
ceammc_cxx_extension(list rotate)
ceammc_cxx_extension(list seq)
ceammc_cxx_extension(list shuffle)
ceammc_cxx_extension(list sort)
ceammc_c_extension(list sum)
ceammc_cxx_extension(list unique)
ceammc_cxx_extension(list pack)
ceammc_c_extension(list unpack)
ceammc_cxx_extension(list gen)
ceammc_cxx_extension(list zip)

# STREAM
ceammc_cxx_extension(reject if)
ceammc_cxx_extension(reject this)
ceammc_cxx_extension(pass if)
ceammc_cxx_extension(pass this)

###############################
# IS
###############################
ceammc_cxx_extension_(is even)
ceammc_cxx_extension_(is odd)
ceammc_cxx_extension_(is any)
ceammc_cxx_extension_(is bang)
ceammc_cxx_extension_(is float)
ceammc_cxx_extension_(is list)
ceammc_cxx_extension_(is symbol)
ceammc_cxx_extension_(is pointer)

###############################
# TIME
###############################
# ceammc_cxx_extension(time current)

###############################
# STRING
###############################

###############################
# PATH
###############################

include(FindLibSndFile)
if(LIBSNDFILE_FOUND)
    include_directories(${LIBSNDFILE_INCLUDE_DIRS})
#    pd_add_extension(NAME ffmpeg FILES ffmpeg.cpp 
#    INTERNAL True LINK ceammc_static ${LIBSNDFILE_LIBRARIES})
endif()

# we need 1.47.0 for boost random uniform distribution
find_package(Boost 1.47.0)
if(Boost_FOUND)
    include_directories(${Boost_INCLUDE_DIRS})
    ceammc_cxx_extension(math prime)
    pd_add_extension(NAME test.data   FILES test_data.cpp   INTERNAL True LINK ceammc_static)
    pd_add_extension(NAME test.expect FILES test_expect.cpp INTERNAL True LINK ceammc_static)
    ceammc_cxx_extension(random float)
    ceammc_cxx_extension(random int)
    ceammc_cxx_extension(random gauss)

    # symbol
    ceammc_cxx_extension(symbol ends_with)
#    ceammc_cxx_extension(symbol to_upper)
endif()


find_package(GLIB)
if(GLIB_FOUND)
    include_directories(${GLIB_INCLUDE_DIRS})

    ceammc_glib_extension(path basename)
    ceammc_glib_extension(path dirname)
    ceammc_glib_extension(path exists)
    ceammc_glib_extension(path home)
    ceammc_glib_extension(path listdir)

    ceammc_glib_extension(string length)
    ceammc_glib_extension(string reverse)
    ceammc_glib_extension(string to_lower)
    ceammc_glib_extension(string to_upper)

    ceammc_glib_extension(system hostname)
    ceammc_glib_extension(system getenv)
    ceammc_glib_extension_(is file)
endif()

ceammc_cxx_extension(system memsize)
ceammc_cxx_extension(system memused)

###############################
# DSP
###############################
#pd_add_extension(NAME impulse~ FILES lfo_impulse.cpp INTERNAL TRUE)
ceammc_faust_extension(lfo impulse simple_pd_ext)
ceammc_faust_extension(lfo tri simple_pd_ext)
ceammc_faust_extension(lfo square simple_pd_ext)
ceammc_faust_extension(osc sinfb simple_pd_control_ext)

ceammc_faust_extension(env adsr simple_pd_control_ext)


